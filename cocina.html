<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cocina Sushi</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial;
  background:#111;
  color:#fff;
  padding:10px;
  max-width:480px;
  margin:auto;
}

.card {
  background:#1f1f1f;
  margin:12px 0;
  padding:12px;
  border-radius:10px;
}

.items {
  background:#000;
  padding:8px;
  margin:8px 0;
  border-radius:6px;
  font-size:14px;
}

button {
  margin:4px 4px 0 0;
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}

.nuevo { border-left:5px solid #777 }
.preparando { border-left:5px solid orange }
.listo { border-left:5px solid limegreen }
</style>
</head>

<body>

<h2>ğŸ³ Cocina</h2>
<div id="lista"></div>

<script>
const API   = "https://script.google.com/macros/s/AKfycbxFTMvsq1mR55_9W--Tpck5hurue8SJSo1LNm4tIGbnTIwSgXUKVFKyVwxLEQBWEqDh/exec";
const TOKEN = "SUSHI2025";

const lista = document.getElementById("lista");

/* ===== CARGAR PEDIDOS ===== */
function cargarPedidos() {
  fetch(`${API}?action=pedidos&token=${TOKEN}`)
    .then(r => r.json())
    .then(data => {
      lista.innerHTML = "";

      if (!data.length) {
        lista.innerHTML = "<p>No hay pedidos</p>";
        return;
      }

      data.forEach(p => {
        const div = document.createElement("div");
        div.className = `card ${p.estado}`;

        // Agrupar productos iguales
        const resumen = {};
        p.items.forEach(i => {
          resumen[i.nombre] = (resumen[i.nombre] || 0) + 1;
        });

        let itemsHTML = "";
        for (let nombre in resumen) {
          itemsHTML += `â€¢ ${resumen[nombre]} x ${nombre}<br>`;
        }

        div.innerHTML = `
          <b>#${p.pedido_id}</b> â€” ${p.tipo.toUpperCase()}<br>
          Cliente: ${p.cliente}<br>

          <div class="items">
            ${itemsHTML}
          </div>

          <b>Total: $${p.total}</b><br>
          Estado: <b>${p.estado}</b><br>

          <button onclick="estado(${p.pedido_id},'preparando')">ğŸ‘¨â€ğŸ³ Preparando</button>
          <button onclick="estado(${p.pedido_id},'listo')">âœ… Listo</button>
          <button onclick="estado(${p.pedido_id},'entregado')">ğŸ“¦ Entregado</button>
        `;

        lista.appendChild(div);
      });
    });
}

/* ===== CAMBIAR ESTADO ===== */
function estado(id, estado) {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "estadopedido",
      token: TOKEN,
      pedido_id: id,
      estado
    })
  })
  .then(r => r.json())
  .then(r => {
    if (r.notify) {
      const msg = `ğŸ£ Hola ${r.cliente}, tu pedido #${r.pedido_id} estÃ¡ LISTO ğŸ™Œ`;
      window.open(
        `https://wa.me/56${r.telefono}?text=${encodeURIComponent(msg)}`,
        "_blank"
      );
    }
    cargarPedidos();
  });
}

setInterval(cargarPedidos, 5000);
cargarPedidos();
</script>

</body>
</html>

