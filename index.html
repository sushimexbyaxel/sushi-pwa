<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sushi Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#111; color:#fff; padding:10px }
.card {
  background:#222; padding:10px; margin:10px 0;
  border-radius:8px
}
button {
  padding:6px 10px; margin:5px;
  border:none; border-radius:5px;
  cursor:pointer
}
input, select {
  width:100%; padding:6px; margin:5px 0
}
</style>
</head>

<body>

<h2>üç£ Men√∫ Sushi</h2>
<div id="menu"></div>

<h3>üõí Carrito</h3>
<div id="carrito"></div>

<h3>üìã Datos Cliente</h3>
<input id="cliente" placeholder="Nombre">
<input id="telefono" placeholder="Tel√©fono">

<label>
  <input type="radio" name="tipo" value="retiro" checked> Retiro
</label>
<label>
  <input type="radio" name="tipo" value="despacho"> Despacho
</label>

<input id="direccion" placeholder="Direcci√≥n (solo despacho)" style="display:none">

<button onclick="enviarPedido()">Enviar Pedido</button>

<script>
const API = "https://script.google.com/macros/s/AKfycbxFTMvsq1mR55_9W--Tpck5hurue8SJSo1LNm4tIGbnTIwSgXUKVFKyVwxLEQBWEqDh/exec";
const TOKEN = "SUSHI2025";

const menuDiv = document.getElementById("menu");
const carritoDiv = document.getElementById("carrito");
const cliente = document.getElementById("cliente");
const telefono = document.getElementById("telefono");
const direccion = document.getElementById("direccion");

let carrito = [];

/* ===== MEN√ö ===== */
fetch(`${API}?action=menu&token=${TOKEN}`)
  .then(r => r.json())
  .then(data => {
    menuDiv.innerHTML = "";
    data.forEach(p => {
      const d = document.createElement("div");
      d.className = "card";
      d.innerHTML = `
        <b>${p.nombre}</b><br>
        ${p.descripcion}<br>
        $${p.precio}<br>
        <button onclick="agregar(${p.id},'${p.nombre}',${p.precio})">
          Agregar
        </button>
      `;
      menuDiv.appendChild(d);
    });
  });

/* ===== CARRITO ===== */
function agregar(id, nombre, precio) {
  carrito.push({ id, nombre, precio });
  renderCarrito();
}

function renderCarrito() {
  carritoDiv.innerHTML = "";
  let total = 0;

  carrito.forEach((p,i) => {
    total += p.precio;
    carritoDiv.innerHTML += `
      ${p.nombre} - $${p.precio}
      <button onclick="quitar(${i})">X</button><br>
    `;
  });

  carritoDiv.innerHTML += `<b>Total: $${total}</b>`;
}

function quitar(i) {
  carrito.splice(i,1);
  renderCarrito();
}

/* ===== PEDIDO ===== */
document.querySelectorAll("input[name='tipo']").forEach(r => {
  r.onchange = () => {
    direccion.style.display =
      r.value === "despacho" && r.checked ? "block" : "none";
  };
});

function enviarPedido() {
  if (!cliente.value || !telefono.value) {
    alert("Completa tus datos");
    return;
  }

  if (carrito.length === 0) {
    alert("Carrito vac√≠o");
    return;
  }

  const tipo = document.querySelector("input[name='tipo']:checked").value;
  const total = carrito.reduce((s,p)=>s+p.precio,0);

  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "nuevopedido",
      token: TOKEN,
      tipo,
      cliente: cliente.value,
      telefono: telefono.value,
      direccion: direccion.value,
      items: carrito,
      total
    })
  })
  .then(r => r.json())
  .then(r => {
    const msg =
`üç£ Nuevo Pedido #${r.pedido_id}
Cliente: ${cliente.value}
Tel√©fono: ${telefono.value}
Tipo: ${tipo}
Total: $${total}`;

    window.open(
      `https://wa.me/56${telefono.value}?text=${encodeURIComponent(msg)}`,
      "_blank"
    );

    alert("Pedido enviado");
    carrito = [];
    renderCarrito();
  });
}
</script>

</body>
</html>
